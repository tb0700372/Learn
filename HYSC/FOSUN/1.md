# 库存流转报表

> Teng  2019.07.23.14.45.01添加

## 添加到报表菜单

```sql

DECLARE @S_MODULEID AS VARCHAR(4)     --参照ID
DECLARE @S_REFID AS INT               --参照REF
DECLARE @MODULEID AS VARCHAR(4)       --选项ID
DECLARE @REFID AS INT                 --选项REF
DECLARE @DESCRIPTION AS VARCHAR(30)   --选项名称

SELECT @S_MODULEID='9102',@MODULEID='9106',@S_REFID=9102001,@REFID=9901006,@DESCRIPTION='库存流转记录'

IF EXISTS (SELECT MODULEID FROM SEC_MODULELIST WHERE MODULEID=@MODULEID)
  ------------------- 菜单ID
  BEGIN
    SELECT Error='菜单ID ['+ @MODULEID +'] 已存在,请指定新的ID'
    SELECT MODULEID,DESCRIPTION,MODULEGROUP FROM SEC_MODULELIST
  END
ELSE IF EXISTS (SELECT DESCRIPTION FROM SEC_MODULELIST WHERE DESCRIPTION=@DESCRIPTION)
  ------------------- 菜单名称
  BEGIN
    SELECT Error='菜单名称已存在,请指定新的名称'
    SELECT MODULEID,DESCRIPTION,MODULEGROUP FROM SEC_MODULELIST
  END
ELSE
  BEGIN
  --添加新菜单到列表
  INSERT dbo.SEC_MODULELIST(
  MODULEID,SUBSYSID,DESCRIPTION,MODULETYPE,MODULEGROUP,GROUPTYPE,NAVIGATEURL,DLLNAME,CALLER,FUNCNAME,PARAMS,TARGET,IMAGEURL,ICONCLS,VISIBLE,ENTRANCE,FIXEDFLAG,DESCR_ENG
  )
    SELECT MODULEID=@MODULEID ,SUBSYSID,DESCRIPTION=@DESCRIPTION,MODULETYPE,MODULEGROUP,GROUPTYPE,NAVIGATEURL,DLLNAME,CALLER,FUNCNAME,PARAMS,TARGET,IMAGEURL,ICONCLS,VISIBLE,ENTRANCE,FIXEDFLAG,DESCR_ENG
      FROM SEC_MODULELIST WHERE MODULEID=@S_MODULEID
  END
  --添加菜单
  INSERT dbo.WEB_MENUHD(
    REFID ,CLIENTID ,MODULEID ,MODULEGROUP ,CAPTION ,SPNAME ,PRINTFILE ,EXCELMACRO ,TARGET ,EXCEL_ROW ,EXCEL_COL ,SHORTCUT ,IMAGEURL ,NAVIGATEURL ,GROUPTYPE ,MENUTYPE ,SPDTNAME ,VISIBLE ,EXCELFILERULE
    )
    SELECT '9901006' REFID,CLIENTID ,MODULEID='9106' ,MODULEGROUP ,CAPTION='库存流转记录','spInventory_log' SPNAME ,PRINTFILE ,EXCELMACRO ,TARGET ,EXCEL_ROW ,EXCEL_COL ,SHORTCUT ,IMAGEURL ,NAVIGATEURL ,GROUPTYPE ,MENUTYPE ,SPDTNAME ,VISIBLE ,EXCELFILERULE
      FROM dbo.WEB_MENUHD
      WHERE REFID='9102001'

验证结果
SELECT * FROM dbo.SEC_MODULELIST WHERE MODULEID=@MODULEID
SELECT * FROM dbo.WEB_MENUHD WHERE REFID=@REFID

```

## 存储过程

```sql

USE [HYSC_3PL_FOSUN]
GO
/******
  Object:  StoredProcedure [dbo].[spInventory_log]
  Script Date: 07/25/2019 10:13:19
******/

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/*
调用实例

*/

ALTER PROC [dbo].[spInventory_log]
(
  @USERID      VARCHAR(30),
  @CLIENTID    VARCHAR(15),
  @STARTDATE    VARCHAR(10),
  @ENDDATE    VARCHAR(10),
  @PAGEINDEX    INT OUTPUT
)AS
--------------------------------------------------------------------BEGIN---------------------------------------------------------------
BEGIN
  DECLARE @Cache AS TABLE(单据时间 datetime,编辑时间 datetime,添加人 varchar(50),编辑人 varchar(50),单据类型 VARCHAR(50),备注 VARCHAR(200),单据编号 varchar(50),源产品 varchar(50),源数量 int,目标产品 varchar(50),目标数量 int )

  INSERT INTO @Cache
    SELECT A.ADDDATE 单据时间,A.EDITDATE 编辑时间,A.ADDBY 添加人,A.EDITBY 编辑人,'入库单' 单据类型,'' 备注,A.RECEIPTID 单据编号,B.ITEMID 源产品,0 源数量,B.ITEMID 目标产品,B.QTYEXPECTED 目标数量
      FROM dbo.RECEIPTHD A LEFT JOIN dbo.RECEIPTDT B ON A.RECEIPTID = B.RECEIPTID WHERE A.STATUSID>=25

  INSERT INTO @Cache
    SELECT A.ADDDATE 单据时间,A.EDITDATE 编辑时间,A.ADDBY 添加人,A.EDITBY 编辑人,'订单' 单据类型,'' 备注,A.ORDERID 单据编号,B.ITEMID 源产品,0 源数量,B.ITEMID 目标产品,B.QTY 目标数量
      FROM dbo.ORDERHD A LEFT JOIN dbo.ORDERDT B ON B.ORDERID = A.ORDERID WHERE A.STATUSID>=75

  INSERT INTO @Cache
    SELECT A.ADDDATE 单据时间,A.EDITDATE 编辑时间,A.ADDBY 添加人,A.EDITBY 编辑人,'调整单' 单据类型,A.NOTES 备注,A.ADJUSTID 单据编号,B.S_ITEMID 源产品,B.S_QTY 源数量,B.D_ITEMID 目标产品,B.D_QTY 目标数量
      FROM dbo.ADJUSTHD A LEFT JOIN dbo.ADJUSTDT  B ON B.ADJUSTID = A.ADJUSTID WHERE A.STATUSID>=75

  INSERT INTO @Cache
    SELECT A.ADDDATE 单据时间,A.EDITDATE 编辑时间,A.ADDBY 添加人,A.EDITBY 编辑人,'移库单' 单据类型,A.NOTES 备注,A.TRANSFERID 单据编号,B.ITEMID 源产品,B.S_QTY 源数量,B.ITEMID 目标产品,B.D_QTY 目标数量
      FROM dbo.TRANSFERHD A LEFT JOIN dbo.TRANSFERDT B ON B.TRANSFERID = A.TRANSFERID  WHERE A.STATUSID>=75
  
  DECLARE @WHSID VARCHAR(6)
  SELECT @WHSID = ISNULL(WHSID,'') FROM SEC_USER WHERE USERID = @USERID
  DECLARE  @PAGENUM  INT
  --缺省一页为100
  SET @PAGENUM = 100
  --PAGEINDEX为0时，系统需要返回记录数
  --PRINT @PAGEINDEX
  IF @PAGEINDEX <> 0
  -------------------------------------@PAGEINDEX <> 0   BEGIN------------------------------
  BEGIN

    --若PAGEINDX为-1,则需要返回所有记录
    IF @PAGEINDEX = -1
    BEGIN
      SET @PAGEINDEX = 1
      SET @PAGENUM = 99999 -- 最多记录
    END
  END
  -------------------------------------@PAGEINDEX <> 0   BEGIN------------------------------
  ELSE
  ------------COUNT(1)  BEGIN----------------
  BEGIN
  SELECT   RECORDCOUNT=COUNT(1) FROM @Cache

    --PRINT @PAGEINDEX
    IF @PAGEINDEX = 0  SET @PAGEINDEX = 1
    --SET @PAGEINDEX = 1
  END
  ------------COUNT(1)  END----------------
  SELECT * FROM (
    SELECT ROW=ROW_NUMBER() OVER (ORDER BY A.单据时间),A.* FROM @Cache A)B
      WHERE B.ROW BETWEEN (@PAGEINDEX-1)*@PAGENUM+1 AND ( @PAGEINDEX-1)*@PAGENUM+@PAGENUM ORDER BY ROW
END


```

## 添加按钮

```sql

INSERT dbo.WEB_MENUDT
  (
  REFID,LINENUMBER,NAME,CONTROLTYPE,CAPTION,WIDTH,ROW,ROWLINE,PARAMFLG,PARAMNAME,DEFAULTVALUE,LEFTLITERAL,RIGHTLITERAL,CLIENTSCRIPT,CONFIG,REMARK
  )
SELECT
  '9901006' REFID,LINENUMBER,NAME,CONTROLTYPE,CAPTION,WIDTH,ROW,ROWLINE,PARAMFLG,PARAMNAME,DEFAULTVALUE,LEFTLITERAL,RIGHTLITERAL,CLIENTSCRIPT,CONFIG,REMARK
FROM dbo.WEB_MENUDT WHERE REFID=9106002 AND LINENUMBER='00001'

```
